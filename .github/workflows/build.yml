name: Build Video Editor

on:
  push:
    branches: [main, master]
    tags:
      - "v*"
  pull_request:
    branches: [main, master]
  workflow_dispatch: # Manual trigger

jobs:
  build-macos:
    runs-on: macos-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Download FFmpeg
        run: |
          mkdir -p bin
          curl -L "https://evermeet.cx/ffmpeg/getrelease/ffmpeg/zip" -o bin/ffmpeg.zip
          unzip -o bin/ffmpeg.zip -d bin/
          rm bin/ffmpeg.zip
          chmod +x bin/ffmpeg

      - name: Build with PyInstaller
        run: |
          pyinstaller --name "VideoEditor" \
            --windowed \
            --onedir \
            --add-data "assets:assets" \
            --add-binary "bin/ffmpeg:bin" \
            --hidden-import "PyQt6.QtCore" \
            --hidden-import "PyQt6.QtGui" \
            --hidden-import "PyQt6.QtWidgets" \
            --hidden-import "PyQt6.QtMultimedia" \
            --hidden-import "PyQt6.QtMultimediaWidgets" \
            --hidden-import "yt_dlp" \
            --hidden-import "PIL" \
            --hidden-import "PIL.Image" \
            --hidden-import "mutagen" \
            --hidden-import "deep_translator" \
            --hidden-import "edge_tts" \
            --hidden-import "whisper" \
            --exclude-module "matplotlib" \
            --exclude-module "pandas" \
            --noconfirm \
            main.py

      - name: Create DMG
        run: |
          # Create a simple zip for now
          cd dist
          zip -r ../VideoEditor-macOS.zip VideoEditor.app

      - name: Upload macOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: VideoEditor-macOS
          path: VideoEditor-macOS.zip

  build-windows:
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Download FFmpeg
        run: |
          mkdir -p bin
          Invoke-WebRequest -Uri "https://www.gyan.dev/ffmpeg/builds/ffmpeg-release-essentials.zip" -OutFile "bin\ffmpeg.zip"
          Expand-Archive -Path "bin\ffmpeg.zip" -DestinationPath "bin\ffmpeg_temp" -Force
          $ffmpegDir = Get-ChildItem -Path "bin\ffmpeg_temp" -Directory | Select-Object -First 1
          Copy-Item "$($ffmpegDir.FullName)\bin\ffmpeg.exe" -Destination "bin\ffmpeg.exe"
          Remove-Item -Recurse -Force "bin\ffmpeg_temp"
          Remove-Item "bin\ffmpeg.zip"
        shell: powershell

      - name: Build with PyInstaller
        run: |
          pyinstaller --name "VideoEditor" `
            --windowed `
            --onefile `
            --add-data "assets;assets" `
            --add-binary "bin\ffmpeg.exe;bin" `
            --hidden-import "PyQt6.QtCore" `
            --hidden-import "PyQt6.QtGui" `
            --hidden-import "PyQt6.QtWidgets" `
            --hidden-import "PyQt6.QtMultimedia" `
            --hidden-import "PyQt6.QtMultimediaWidgets" `
            --hidden-import "yt_dlp" `
            --hidden-import "PIL" `
            --hidden-import "PIL.Image" `
            --hidden-import "mutagen" `
            --hidden-import "deep_translator" `
            --hidden-import "edge_tts" `
            --hidden-import "whisper" `
            --exclude-module "matplotlib" `
            --exclude-module "pandas" `
            --noconfirm `
            main.py
        shell: powershell

      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: VideoEditor-Windows
          path: dist/VideoEditor.exe

  release:
    needs: [build-macos, build-windows]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')

    steps:
      - name: Download macOS artifact
        uses: actions/download-artifact@v4
        with:
          name: VideoEditor-macOS

      - name: Download Windows artifact
        uses: actions/download-artifact@v4
        with:
          name: VideoEditor-Windows

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            VideoEditor-macOS.zip
            VideoEditor.exe
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
