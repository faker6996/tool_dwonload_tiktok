name: Build Video Editor

on:
  push:
    branches: [main, master]
    tags:
      - "v*"
  pull_request:
    branches: [main, master]
  workflow_dispatch:

jobs:
  build-macos:
    runs-on: macos-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Download FFmpeg
        run: |
          mkdir -p bin
          curl -L "https://evermeet.cx/ffmpeg/getrelease/ffmpeg/zip" -o bin/ffmpeg.zip
          unzip -o bin/ffmpeg.zip -d bin/
          rm bin/ffmpeg.zip
          chmod +x bin/ffmpeg

      - name: Build with PyInstaller
        run: |
          pyinstaller --name "VideoEditor" \
            --windowed \
            --onedir \
            --add-data "assets:assets" \
            --add-binary "bin/ffmpeg:bin" \
            --hidden-import "PyQt6.QtCore" \
            --hidden-import "PyQt6.QtGui" \
            --hidden-import "PyQt6.QtWidgets" \
            --hidden-import "PyQt6.QtMultimedia" \
            --hidden-import "PyQt6.QtMultimediaWidgets" \
            --hidden-import "yt_dlp" \
            --hidden-import "PIL" \
            --hidden-import "PIL.Image" \
            --hidden-import "mutagen" \
            --hidden-import "deep_translator" \
            --hidden-import "edge_tts" \
            --hidden-import "whisper" \
            --hidden-import "easyocr" \
            --hidden-import "cv2" \
            --hidden-import "openai" \
            --hidden-import "google.generativeai" \
            --collect-all "easyocr" \
            --collect-all "torch" \
            --exclude-module "matplotlib" \
            --exclude-module "pandas" \
            --noconfirm \
            main.py

      - name: Install create-dmg
        run: brew install create-dmg

      - name: Create DMG
        run: |
          create-dmg \
            --volname "Video Editor" \
            --volicon "assets/app_icon.icns" \
            --window-pos 200 120 \
            --window-size 600 400 \
            --icon-size 100 \
            --icon "VideoEditor.app" 150 185 \
            --hide-extension "VideoEditor.app" \
            --app-drop-link 450 185 \
            "VideoEditor-macOS.dmg" \
            "dist/VideoEditor.app" || \
          # Fallback to zip if DMG creation fails
          (cd dist && zip -r ../VideoEditor-macOS.zip VideoEditor.app)

      - name: Upload macOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: VideoEditor-macOS
          path: |
            VideoEditor-macOS.dmg
            VideoEditor-macOS.zip

  build-linux:
    runs-on: ubuntu-22.04

    steps:
      - uses: actions/checkout@v4

      - name: Free disk space
        run: |
          echo "Freeing up disk space..."
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force
          df -h

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libxcb-xinerama0 \
            libxcb-cursor0 \
            libxkbcommon-x11-0 \
            libgl1-mesa-glx \
            libegl1-mesa \
            libxcb-icccm4 \
            libxcb-image0 \
            libxcb-keysyms1 \
            libxcb-randr0 \
            libxcb-render-util0 \
            libxcb-shape0 \
            ffmpeg \
            fuse \
            libfuse2

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          # Install CPU-only torch first (smaller)
          pip install torch torchvision --index-url https://download.pytorch.org/whl/cpu
          # Install other dependencies (exclude mlx-whisper - Mac only)
          pip install PyQt6 requests yt-dlp qtawesome pillow ffmpeg-python \
            openai-whisper edge-tts deep-translator google-generativeai openai \
            opencv-python easyocr pyktok playwright mutagen
          pip install pyinstaller

      - name: Build with PyInstaller
        run: |
          pyinstaller --name "VideoEditor" \
            --onedir \
            --add-data "assets:assets" \
            --hidden-import "PyQt6.QtCore" \
            --hidden-import "PyQt6.QtGui" \
            --hidden-import "PyQt6.QtWidgets" \
            --hidden-import "PyQt6.QtMultimedia" \
            --hidden-import "PyQt6.QtMultimediaWidgets" \
            --hidden-import "yt_dlp" \
            --hidden-import "PIL" \
            --hidden-import "PIL.Image" \
            --hidden-import "mutagen" \
            --hidden-import "deep_translator" \
            --hidden-import "edge_tts" \
            --hidden-import "whisper" \
            --hidden-import "easyocr" \
            --hidden-import "cv2" \
            --collect-all "easyocr" \
            --exclude-module "matplotlib" \
            --exclude-module "pandas" \
            --noconfirm \
            main.py

      - name: Create tar.gz archive
        run: |
          cd dist
          tar -czvf ../VideoEditor-Linux.tar.gz VideoEditor/

      - name: Upload Linux artifact
        uses: actions/upload-artifact@v4
        with:
          name: VideoEditor-Linux
          path: VideoEditor-Linux.tar.gz

  build-windows:
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Download FFmpeg
        run: |
          mkdir -p bin
          Invoke-WebRequest -Uri "https://www.gyan.dev/ffmpeg/builds/ffmpeg-release-essentials.zip" -OutFile "bin\ffmpeg.zip"
          Expand-Archive -Path "bin\ffmpeg.zip" -DestinationPath "bin\ffmpeg_temp" -Force
          $ffmpegDir = Get-ChildItem -Path "bin\ffmpeg_temp" -Directory | Select-Object -First 1
          Copy-Item "$($ffmpegDir.FullName)\bin\ffmpeg.exe" -Destination "bin\ffmpeg.exe"
          Remove-Item -Recurse -Force "bin\ffmpeg_temp"
          Remove-Item "bin\ffmpeg.zip"
        shell: powershell

      - name: Build with PyInstaller
        run: |
          pyinstaller --name "VideoEditor" `
            --windowed `
            --onedir `
            --add-data "assets;assets" `
            --add-binary "bin\ffmpeg.exe;bin" `
            --collect-all "PyQt6" `
            --hidden-import "PyQt6" `
            --hidden-import "PyQt6.QtCore" `
            --hidden-import "PyQt6.QtGui" `
            --hidden-import "PyQt6.QtWidgets" `
            --hidden-import "PyQt6.QtMultimedia" `
            --hidden-import "PyQt6.QtMultimediaWidgets" `
            --hidden-import "PyQt6.sip" `
            --hidden-import "yt_dlp" `
            --hidden-import "PIL" `
            --hidden-import "PIL.Image" `
            --hidden-import "mutagen" `
            --hidden-import "deep_translator" `
            --hidden-import "edge_tts" `
            --hidden-import "whisper" `
            --hidden-import "requests" `
            --hidden-import "easyocr" `
            --hidden-import "cv2" `
            --hidden-import "openai" `
            --hidden-import "google.generativeai" `
            --collect-all "easyocr" `
            --collect-all "torch" `
            --exclude-module "matplotlib" `
            --exclude-module "pandas" `
            --noconfirm `
            main.py
        shell: powershell

      - name: Install Inno Setup
        run: choco install innosetup -y
        shell: cmd

      - name: Create installer directory
        run: mkdir installer
        shell: cmd

      - name: Build Installer with Inno Setup
        run: |
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" "scripts\installer.iss"
        shell: powershell

      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: VideoEditor-Windows
          path: installer/VideoEditor-Setup.exe

  release:
    needs: [build-macos, build-linux, build-windows]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')

    steps:
      - name: Download macOS artifact
        uses: actions/download-artifact@v4
        with:
          name: VideoEditor-macOS

      - name: Download Linux artifact
        uses: actions/download-artifact@v4
        with:
          name: VideoEditor-Linux

      - name: Download Windows artifact
        uses: actions/download-artifact@v4
        with:
          name: VideoEditor-Windows

      - name: List files
        run: ls -la

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            VideoEditor-macOS.dmg
            VideoEditor-macOS.zip
            VideoEditor-Linux.tar.gz
            VideoEditor-Setup.exe
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
